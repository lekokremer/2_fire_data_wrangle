---
title: "Kremer_hmwrk2_wrangling_data"
author: "Lauren Kremer"
date: "2/4/2022"
output: html_document
---

Install needed packages with a function. If the code is being used on a 
computer that does not have these packages, the function will install them.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pkgTest <- function(x)
{
  if (x %in% rownames(installed.packages()) == FALSE) {
    install.packages(x, dependencies= TRUE)
  }
  library(x, character.only = TRUE)
}

# Make a vector of the packages you need
neededPackages <- c('tidyverse', 'tidyr', 'ggthemes', 'lubridate', 'ggpubr', 'dygraphs') 

for (package in neededPackages){pkgTest(package)}
```

# Opening the data:
  Generate a function that:
  
  1. opens all files in the data folder and 
  
  2. adds the index name as a column value to the dataframe
  
  3. concatonates the data into one df

```{r}
opn_concat_co <- function(data_folder) {
  path_list <- paste(getwd(),list.files(data_folder, full.names = T), sep='/')
  data <- lapply(path_list, function(x) {
    dat <- read.csv(x)%>% 
    rename(burned=2,unburned=3) %>%
    mutate(data = strsplit(strsplit(strsplit(x, "/")[[1]][9], '_')[[1]][2], '\\.')[[1]][1])
    return(dat)
  })
  combined.data <- do.call(rbind, data)
  return(combined.data)
}

```

Open the data for the assingment:

```{r}
# Open as a long dataset
full_long <- opn_concat_co('data') %>%
  gather(key='site',value='value',-DateTime,-data) %>%
  filter(!is.na(value))
```

**Question 1**

1. What is the correlation between NDVI and NDMI? - here I want you to
 convert the full_long dataset in to a wide dataset using the 
 function "spread" and then make a plot that shows the correlation as a
 function of if the site was burned or not


-Using spread(), convert long dataset into wide<br />
-remove rows with NA vaues<br />
-add a 'month' and 'year' column for aggregation<br />

```{r}
full_wide <- spread(data=full_long, key='data',value='value') %>%
  filter_if(is.numeric,all_vars(!is.na(.))) %>%
  mutate(month = month(DateTime),
         year = year(DateTime))

site_names <- c('burned' = "Burned", 
                'unburned' = "Unburned") # using this as a labeller for the 
# facet wrap

ggplot(full_wide,aes(x=ndmi,y=ndvi)) + 
  geom_point() + 
  geom_smooth(method='lm', formula= y~x) + #show correlation...
  facet_wrap(~site, labeller = as_labeller(site_names)) + #...as a function of burned status
  stat_cor(aes(label = ..rr.label..), color = "red", geom = "label") + # show the r2 value in red
  theme_few() + # remove grid patterns from figure background
  xlab("NDMI") +
  ylab("NDVI")

```
**Response**
**It appears as though there is a greater correlation between NDVI and NDMI in unburned plots than burned plots, though there is a lot of varaibility. There may be some winter points (e.g. high NDMI, low NDVI) that could be removed to make relationships more clear. Additionally, evaluating these relationships with the addition of a seasonal classification may be reveal the nature of the relationships while reducing some variation**


**Question 2**
2. What is the correlation between average NDSI (normalized 
 snow index) for January - April and average NDVI for June-August?
In other words, does the previous year's snow cover influence vegetation
 growth for the following summer? 

Using the wide dataframe to keep month column, 
-select needed columns, <br />
-make dataframe long for easy filtering <br />
-filter the dataframe with an 'or', keeping every NDSIvalue in winter months month %in%  c(1,2,3,4), and NDVI values in summer months month %in% c(6,7,8) <br />
-average NDVI and NDSI values by year <br />
-spread the data to plot NDVI vs. NDSI <br />

```{r}
plot_data <- full_wide %>% 
  select(c(month, year, ndvi, ndsi)) %>%
  pivot_longer(c(ndvi,ndsi)) %>%
  filter(name == 'ndvi' & month %in% c(6,7,8) | name== 'ndsi' & month %in% c(1,2,3,4)) %>%
  group_by(year, name) %>% summarize(meanvalue = mean(value)) %>%
  spread(key='name', value='meanvalue')
  
#create line plot for yearly mean...
ggplot(plot_data, aes(ndsi, ndvi)) +
  geom_line() +
  geom_smooth(method='lm', formula= y~x) +
  xlab('NDSI') +
  ylab('NDVI')

```

**Response:**
**There does not appear to be a correlation between NDSI and NDVI at these sites.  However, both indices reflect a lot of annual variability even with the limited months.**


**Question 3**
How is the snow effect from question 2 different between pre- and post-burn
and burned and unburned? 

Using the wide dataframe to keep month column, 
-select needed columns, <br />
-make dataframe long for easy filtering <br />
-filter the dataframe with an 'or', keeping every NDSIvalue in winter months month %in%  c(1,2,3,4), and NDVI values in summer months month %in% c(6,7,8) <br />
-average NDVI and NDSI values by year, and burn status <br />
-spread the data to plot NDVI vs. NDSI <br />

```{r}
plot_data_fire <- full_wide %>% 
  select(c(month, year, ndvi, ndsi, site)) %>%
  pivot_longer(c(ndvi,ndsi)) %>%
  filter(name == 'ndvi' & month %in% c(6,7,8) | name== 'ndsi' & month %in% c(1,2,3,4)) %>%
  group_by(year, name, site) %>% summarize(meanvalue = mean(value)) %>%
  spread(key='name', value='meanvalue')
  
#create line plot for yearly mean...
ggplot(plot_data_fire, aes(ndsi, ndvi, color = site)) +
  geom_line() +
  geom_smooth(method='lm', formula= y~x) +
  xlab('NDSI') +
  ylab('NDVI') +
  scale_color_manual(name="Burn status",
                       labels=c("Burned","Unburned"),
                       values=c("darkred", "navy"))
install.packages('ggstatsplot')
install.packages('ggside')
library(ggstatsplot)
ggstatsplot::ggscatterstats(data = plot_data_fire, x = ndsi, y = ndvi)

# Separating burned from unburned reveals that there may be a greater correlation between NDSI and NDVI in burned sites. 
```


###### Question 4 #####
#What month is the greenest month on average? Does this change in the burned
# plots after the fire? 
```{r}

# To simply print max monthly values for each burn type:
max_ndvi <- full_wide %>% 
  select(c(month, year, ndvi, site)) %>%
  group_by(month, site) %>% 
  summarize(value = mean(ndvi)) %>%
  ungroup()%>%
  group_by(site) %>%
  filter(value == max(value))

max_ndvi

# Or we can look at plots to determine max visually

plot_data_ndvi <- full_wide %>% 
  select(c(month, year, ndvi, site)) %>%
  group_by(month, site) %>% summarize(meanvalue = mean(ndvi))


# generate a plot that compares burned with unburned
ggplot(plot_data_ndvi, aes(month, meanvalue, color = site)) +
  geom_line() +
  xlab('Month') +
  ylab('NDVI') +
  scale_x_continuous(breaks = 1:12, 
                     labels = c('J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D')) +
  scale_color_manual(name="Burn status",
                       labels=c("Burned","Unburned"),
                       values=c("darkred", "navy"))

```
The greenest month appears to be August for the burned plots and September for the unburned plots

##### Question 5 ####
#What month is the snowiest on average?
```{r}
# To simply print max monthly values :
max_ndsi <- full_wide %>% 
  select(c(month, year, ndsi)) %>%
  group_by(month) %>% 
  summarize(value = mean(ndsi)) %>%
  filter(value == max(value))

max_ndsi
# January appears to have maximum monthly mean
# Or we can look at plots to determine max visually

plot_data_ndsi <- full_wide %>% 
  select(c(month, year, ndsi)) %>%
  group_by(month) %>% summarize(meanvalue = mean(ndsi))


# generate a plot that compares burned with unburned
ggplot(plot_data_ndsi, aes(month, meanvalue)) +
  geom_line() +
  xlab('Month') +
  ylab('NDSI') +
  scale_x_continuous(breaks = 1:12, 
                     labels = c('J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D')) 
```

